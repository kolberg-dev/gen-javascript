{{- define "main" -}}

{{- if ne .WebrpcVersion "v1" -}}
  {{- stderrPrintf "%s generator error: unsupported webrpc version %s\n" .WebrpcTarget .WebrpcVersion -}}
  {{- exit 1 -}}
{{- end -}}

{{- if not (minVersion .WebrpcGenVersion "v0.7.0") -}}
  {{- stderrPrintf "%s generator error: unsupported webrpc-gen version %s, please update\n" .WebrpcTarget .WebrpcGenVersion -}}
  {{- exit 1 -}}
{{- end -}}

{{- /* Options with default values. */ -}}
{{- $opts := dict -}}
{{- set $opts "Client" (ternary (in .Opts.Client "" "true") true false) -}}
{{- set $opts "Server" (ternary (in .Opts.Server "" "true") true false) -}}
{{- set $opts "Export" (ternary (in .Opts.Export "false") false true) -}}

{{- /* Print help on -Help. */ -}}
{{- if exists .Opts "Help" -}}
  {{ template "help" $opts }}
  {{- exit 0 -}}
{{- end -}}

{{- /* Print help on unsupported option. */ -}}
{{- range $k, $v := .Opts }}
  {{- if not (exists $opts $k) -}}
    {{- stderrPrintf "  -%v=%q is not supported option\n" $k $v -}}
    {{- template "help" $opts -}}
    {{- exit 1 -}}
  {{- end -}}
{{- end -}}

{{- /* Map webrpc data types to JS. */ -}}
{{- $typeMap := dict }}
{{- set $typeMap "null" "null" -}}
{{- set $typeMap "any" "any" -}}
{{- set $typeMap "byte" "string" -}}
{{- set $typeMap "bool" "boolean" -}}
{{- set $typeMap "uint" "number" -}}
{{- set $typeMap "uint8" "number" -}}
{{- set $typeMap "uint16" "number" -}}
{{- set $typeMap "uint32" "number" -}}
{{- set $typeMap "uint64" "number" -}}
{{- set $typeMap "int" "number" -}}
{{- set $typeMap "int8" "number" -}}
{{- set $typeMap "int16" "number" -}}
{{- set $typeMap "int32" "number" -}}
{{- set $typeMap "int64" "number" -}}
{{- set $typeMap "float32" "number" -}}
{{- set $typeMap "float64" "number" -}}
{{- set $typeMap "string" "string" -}}
{{- set $typeMap "timestamp" "string" -}}

// {{.SchemaName}} {{.SchemaVersion}} {{.SchemaHash}}
// --
// Code generated by webrpc-gen@{{.WebrpcGenVersion}} with {{.WebrpcTarget}} generator. DO NOT EDIT.
//
// {{.WebrpcGenCommand}}

// WebRPC description and code-gen version
export const WebRPCVersion = "{{.WebrpcVersion}}"

// Schema version of your RIDL schema
export const WebRPCSchemaVersion = "{{.SchemaVersion}}"

// Schema hash generated from your RIDL schema
export const WebRPCSchemaHash = "{{.SchemaHash}}"

{{template "types" dict "Services" .Services "Messages" .Messages "Opts" $opts}}
{{- if $opts.Client}}
  {{template "client" dict "Services" .Services "Opts" $opts}}
  {{template "client_helpers" .}}
{{- end}}
{{- if $opts.Server}}
  {{template "server" dict "Services" .Services "Opts" $opts "TypeMap" $typeMap}}
{{- end}}
{{- end}}
